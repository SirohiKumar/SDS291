---
title: "Kumar - SDS 291 Homework 3"
output:
  pdf_document: default
  html_document:
    df_print: paged
---

## HOMEWORK 3: CONDITIONS, CONFOUNDING, AND TRANSFORMATIONS

#### Load libraries
```{r message=FALSE}

library(Stat2Data)
library(performance)
library(ggplot2)
library(equatiomatic)
library(gridExtra)

```

### EXERCISE 1
*you’re concerned that their data do not meet the necessary conditions for inference with a linear regression model*

In order to fit any linear model, all models have to pass the LINE test:

* Linearity test --> plot fitted values for each observation against the residuals of each observation there should be no relationship between the two variables. 
* **Independence test** --> regarding the data collection, the points should not be connected -- this is violated when the same unit is measured over time. 
* Normality test --> a histogram of the residuals should be normal. 
* Equal Variance test --> the standard deviation of the errors should be the same regardless of if the model is predicting large or small values 

The way data was collected for this model violates the Independence Test. 

### EXERCISE 2
*The first thing this analyst wants to investigate is the hypothesis that a home’s sale price is linearly related to its square footage.*

#### Load data
```{r}
data("GrinnellHouses")
head(GrinnellHouses)

```

### EXERCISE 2A:

*Fit a model that is suitable for the analyst’s needs. Then, summarize this model’s goodness of fit using the $R^2$ statistic, and interpret its value for the analyst.*

#### Visualize data + model
```{r warning=FALSE}
ggplot(data = GrinnellHouses, mapping = aes(y = SalePrice, 
                                            x = SquareFeet)) + 
  geom_point() + 
  geom_smooth(method = lm, formula = y ~ x, se = F)

```

#### Generate model
```{r}
price_footage_model = lm(SalePrice ~ SquareFeet, data = GrinnellHouses)
summary(price_footage_model)$coefficients

```

#### Interpreting model

This model's $R^2$ value is $0.4203$, meaning 42.03% of the variance in the data can be explained by the model. Because the model explains so little of the variance (low $R^2$), this model (and thus square footage) do not explain Sale Price very well. 

### EXERCISE 2B: 
*Investigate whether the assumptions that would support using a t-test on the slope coefficient of this model are reasonable to make in this case, and advise the analyst on whether they should consider the t-tests they see in the regression table as reliable.*

#### Assess fit
```{r}
check_model(price_footage_model, check = c("linearity", "homogeneity", 
                                           "qq", "normality"))

```

From these checks, we can see there are only mild violations of the assumptions necessary to make t-tests. When plotted against the fitted values, the residuals have a mostly flat+horizontal spread. While the homogeneity of variance is not entirely constant, the other tests are largely unviolated. The normality of residuals is almost exact, with exceptions at the high end of the bottom left plot. Thus, we can trust the t-tests and view them as reliable. 

### EXERCISE 3
*How does a logarithmic transformation of the outcome variable affect your conclusions about whether the model’s assumptions are reasonably met?*

#### Visualize the transformed model
```{r warning=FALSE}

ggplot(data = GrinnellHouses, mapping = aes(x = SquareFeet, y = log(SalePrice))) +
  geom_point() + 
  geom_smooth(method = lm, formula = y ~ x, se = F)

```

#### Generate model
```{r}

price_logft_model = lm(log(SalePrice) ~ SquareFeet, data = GrinnellHouses)
summary(price_logft_model)

```

#### Assess fit
```{r}

check_model(price_logft_model, check = c("linearity", "homogeneity", 
                                           "qq", "normality"))

```

Upon completing a log transformation of the outcome variable (SalePrice), the assumptions necessary to run t-tests are strongly violated. While the homogeneity of variance has improved, the linearity has gotten slightly worse, and the residuals are nowhere near normal. Thus, we cannot trust the t-tests generated by this model. 

*Interpret what the slope coefficient of this model tells you about the relationship between home price (measured in dollars) and size (measured in square feet).*

The slope coefficient of this model is 4.772e-04, which implies that for each increase in house size by one square foot, the price of the house increases by $0.0004772. 

### EXERCISE 4

*Fit a model that accounts for confounding variables: the size of the lot and the year the home was built* 

I will begin this exercise by visualizing the relationships of these possibly confounding variables with our outcome data. 

#### Visualize data

##### Size of lot and Price
```{r warning=FALSE}

#### NO CURVE, LOG IS BEST

ggplot(data = GrinnellHouses, mapping = aes(x = LotSize,
                                            y = SalePrice)) +
  geom_point() +
  geom_smooth(method = lm, formula = y ~ x, se = F)

```

This model would be easier to interpret and view if we logged the explanatory variable: 
```{r warning=FALSE}

size_price_vis = ggplot(data = GrinnellHouses, mapping = aes(x = log(LotSize),
                                                             y = SalePrice)) +
  geom_point() +
  geom_smooth(method = lm, formula = y ~ x, se = F)

size_price_vis

```

We also know this logged model fits the data better than the untransformed data:
```{r}

lotsize_model = lm(SalePrice ~ LotSize, data = GrinnellHouses)
summary(lotsize_model)$r.squared

```

```{r}

log_model = lm(SalePrice ~ log(LotSize), data = GrinnellHouses)
summary(log_model)$r.squared

```

##### Year home was built and Price

This data has a clear curve, so we generate a quadratic model 
```{r}

year_price_vis = ggplot(data = GrinnellHouses, mapping = aes(x = YearBuilt,
                                                             y = SalePrice)) +
  geom_point() +
  geom_smooth(method = lm, formula = y ~ x + I(x^2), se = F)

year_price_vis

```

```{r}

quad_model = lm(SalePrice ~ YearBuilt + I(YearBuilt^2), data = GrinnellHouses)
summary(quad_model)$r.squared

```

##### Square footage and Price

These two have a linear relationship which we explored earlier, best left untransformed
```{r warning=FALSE}

footage_price_vis = ggplot(data = GrinnellHouses, mapping = aes(x = SquareFeet,
                                                                y = SalePrice)) +
  geom_point() +
  geom_smooth(method = lm, formula = y ~ x, se = F)

footage_price_vis

```

##### Visualize
```{r warning=FALSE}

grid.arrange(size_price_vis, year_price_vis, footage_price_vis, nrow = 2)

```

#### Generate new model

If we combine these three explanatory variables, we can generate a possible new model
```{r}

compound_model = lm(SalePrice ~ SquareFeet + log(LotSize) + YearBuilt + I(YearBuilt^2), data = GrinnellHouses)

summary(compound_model)$adj.r.squared

```

However, we should check to ensure that, when these three variables are combined, our transformations are still necessary: 

##### Without log

This version of the model has a slightly higher adjusted $R^2$ value
```{r}

compound_model = lm(SalePrice ~ SquareFeet + LotSize + YearBuilt + I(YearBuilt^2), data = GrinnellHouses)

summary(compound_model)$coefficients

```
We can view this model:
```{r}

extract_eq(compound_model, use_coefs = T)

```

Based on the following, we can see this model doesn't too badly violate our assumptions. Thus, we can continue to interpret our coefficients. 
```{r}

check_model(compound_model, check = c("linearity", "homogeneity", 
                                           "qq", "normality"))

```

#### Interpret coefficients

* `(Intercept)` = 2.799623e+07 is SalePrice when SquareFeet, LotSize, and YearBuilt are all 0 (not very realistic). 
* `SquareFeet` $= 68.16152$ represents the average increase in SalePrice for each increase by 1 of SquareFeet, when LotSize and YearBuilt are both 0 or don't change.
* `LotSize` $= 4721.14$ is the average change in SalePrice for each increase by 1 of LotSize when SquareFeet and YearBuilt are both 0 or don't change. 
* `YearBuilt` $= -29805.83$ is the average change in SalePrice for each increase by 1 of YearBuilt, when SquareFeet and LotSize are both 0 or don't change. 
* `I(YearBuilt^2)` $= 7.93$ is the average change in SalePrice for each increase in $YearBuilt^2$ by 1, given the SquareFeet and LotSize are both 0 or don't change. 

side note, not sure if this model is correct because we haven't learned about interpreting a complete second order model (not that this is one because it doesn't have a $\beta_1(X_1 * X_2)$ term) even though we learned about them in the textbook. i feel sort of confident in my interpretations, although this might have gotten too sophisticated. 